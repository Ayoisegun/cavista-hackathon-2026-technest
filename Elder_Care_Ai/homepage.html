<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Voice Hub - Elder Care AI</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2ba0ee",
              "background-light": "#f6f7f8",
              "background-dark": "#101b22",
              "success-soft": "#e8f5e9",
              "success-vibrant": "#4caf50",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              "2xl": "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .mic-shadow {
        box-shadow:
          0 0 0 15px rgba(43, 160, 238, 0.1),
          0 10px 30px -5px rgba(43, 160, 238, 0.4);
      }
      .action-card-shadow {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .exit-button {
        transition: all 0.2s ease;
      }
      .exit-button:hover {
        background-color: rgba(43, 160, 238, 0.1);
      }
      .exit-tooltip {
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2ba0ee;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }
      .group:hover .exit-tooltip {
        opacity: 1;
      }
      .listening-pulse {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
      }
      .thinking-dots::after {
        content: '';
        animation: dots 1.5s steps(4, end) infinite;
      }
      @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
      }
      .conversation-container {
        max-height: 300px;
        overflow-y: auto;
        scroll-behavior: smooth;
      }
      @keyframes ring {
        0% { transform: rotate(0deg); }
        10% { transform: rotate(10deg); }
        20% { transform: rotate(-10deg); }
        30% { transform: rotate(8deg); }
        40% { transform: rotate(-8deg); }
        50% { transform: rotate(6deg); }
        60% { transform: rotate(-6deg); }
        70% { transform: rotate(4deg); }
        80% { transform: rotate(-4deg); }
        90% { transform: rotate(2deg); }
        100% { transform: rotate(0deg); }
      }
      .call-ring {
        animation: ring 1.5s ease-in-out infinite;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col font-display"
  >
    <!-- Navigation Bar with Exit Icon -->
    <header
      class="flex items-center justify-between px-6 py-6 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800"
    >
      <div class="flex items-center gap-3">
        <div class="text-primary bg-primary/10 p-2 rounded-xl">
          <span class="material-symbols-outlined text-3xl">home_health</span>
        </div>
        <h1 class="text-xl font-bold tracking-tight">Elder Care AI</h1>
      </div>
      
      <!-- Language Selector - English & Yoruba Only -->
      <div class="flex items-center gap-2">
        <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-1 flex">
          <button onclick="setLanguage('english')" class="px-4 py-1.5 text-sm font-medium rounded-md transition-all" id="lang-en">üá¨üáß English</button>
          <button onclick="setLanguage('yoruba')" class="px-4 py-1.5 text-sm font-medium rounded-md transition-all" id="lang-yo">üá≥üá¨ Yoruba</button>
        </div>
        
        <!-- Exit/Logout Button with tooltip -->
        <div class="relative group">
          <a 
            href="sign_upPage.html" 
            class="exit-button flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 transition-all"
            aria-label="Go to login page"
          >
            <span class="material-symbols-outlined text-slate-600 dark:text-slate-400 group-hover:text-primary">logout</span>
            <span class="text-sm font-medium text-slate-600 dark:text-slate-400 group-hover:text-primary hidden sm:block">Exit</span>
          </a>
          <span class="exit-tooltip">Click to go to login page</span>
        </div>
      </div>
    </header>
    
    <!-- Exit Confirmation Modal -->
    <div id="exitModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
        <div class="text-center mb-6">
          <div class="bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="material-symbols-outlined text-primary text-4xl">logout</span>
          </div>
          <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Leave this page?</h3>
          <p class="text-slate-600 dark:text-slate-400">This will take you back to the login screen.</p>
        </div>
        <div class="flex gap-3">
          <button onclick="closeModal()" class="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50 transition-colors">
            Stay
          </button>
          <a href="sign_upPage.html" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold hover:bg-primary/90 transition-colors text-center">
            Exit
          </a>
        </div>
      </div>
    </div>

    <!-- EMERGENCY CALL SIMULATION MODAL -->
    <div id="emergencyCallModal" class="fixed inset-0 bg-gradient-to-b from-red-600 to-red-800 flex items-center justify-center z-[100] hidden">
      <div class="text-center text-white p-8 max-w-md">
        <div class="call-ring mb-8">
          <div class="w-32 h-32 bg-white/20 rounded-full flex items-center justify-center mx-auto border-4 border-white">
            <span class="material-symbols-outlined text-6xl">call</span>
          </div>
        </div>
        
        <h2 class="text-4xl font-black mb-2" id="emergencyTitle">EMERGENCY CALL</h2>
        <p class="text-2xl mb-2" id="emergencyContact">Contacting Caregiver...</p>
        <p class="text-lg opacity-80 mb-8" id="emergencyMessage">Help is on the way</p>
        
        <div class="text-3xl font-mono mb-8 animate-pulse" id="callTimer">00:00</div>
        
        <button onclick="endEmergencyCall()" class="bg-white text-red-600 px-8 py-4 rounded-full text-xl font-bold hover:bg-red-50 transition-all flex items-center gap-2 mx-auto">
          <span class="material-symbols-outlined">call_end</span>
          <span id="endCallText">End Call</span>
        </button>
        
        <p class="text-sm mt-4 opacity-60" id="emergencyNote">Emergency services have been notified</p>
      </div>
    </div>

    <!-- Conversation History Container -->
    <div class="flex-1 overflow-hidden flex flex-col">
      <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300" id="conversationHeader">Conversation</h2>
          <span class="text-sm text-primary flex items-center gap-1" id="activeLanguage">
            <span>üá¨üáß</span> English
          </span>
        </div>
      </div>
      
      <div class="conversation-container flex-1 px-6 py-4 space-y-4" id="conversationHistory">
        <!-- Welcome message will appear here dynamically -->
      </div>

      <!-- Voice Input Area -->
      <main class="flex flex-col items-center px-6 py-8 bg-gradient-to-t from-white/50 to-transparent">
        <!-- Central Voice Focus Area -->
        <div class="flex flex-col items-center w-full max-w-md space-y-6">
          <!-- Large Microphone Button -->
          <div class="relative group cursor-pointer" onclick="startListening()">
            <!-- Outer Ring (Visual Pulse Indicator) -->
            <div
              class="absolute inset-0 rounded-full bg-primary/20 scale-125 animate-pulse"
              id="micPulse"
            ></div>
            <button
              class="relative z-10 w-40 h-40 rounded-full bg-primary text-white mic-shadow flex items-center justify-center active:scale-95 transition-transform duration-150 hover:scale-105"
              id="micButton"
            >
              <span class="material-symbols-outlined text-6xl font-light" id="micIcon">mic</span>
            </button>
          </div>
          
          <div class="text-center">
            <p
              class="text-lg font-medium text-slate-600 dark:text-slate-400 px-6 py-3 bg-white/50 dark:bg-slate-800/50 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"
              id="statusText"
            >
              Tap the microphone to start
            </p>
          </div>
        </div>
        
        <!-- Quick Actions Grid - Centered Button -->
        <div class="w-full max-w-md mt-8 flex justify-center">
          <!-- Reminders - Centered -->
          <a href="voice_reminder.html" class="block w-full max-w-xs">
            <button
              class="w-full flex items-center justify-center gap-2 p-4 bg-white dark:bg-slate-900 rounded-xl action-card-shadow border-2 border-transparent hover:border-primary hover:bg-primary/5 transition-all group"
            >
              <span class="material-symbols-outlined text-primary">notifications_active</span>
              <span class="text-sm font-medium" id="remindersText">Reminders</span>
            </button>
          </a>
        </div>
      </main>
    </div>
    
    <!-- Bottom Navigation Icons -->
    <nav
      class="sticky bottom-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 px-6 py-3 flex justify-around items-center"
    >
    </nav>
    
    <!-- Visual enhancement -->
    <div
      class="fixed inset-0 pointer-events-none -z-10 bg-[radial-gradient(circle_at_50%_40%,_var(--tw-gradient-stops))] from-primary/5 via-background-light to-background-light dark:from-primary/10 dark:via-background-dark dark:to-background-dark"
    ></div>

    <script>
      // ==================== YARNGPT CONFIGURATION ====================
      const YARNGPT_API_KEY = 'YOUR_YARNGPT_API_KEY_HERE'; // Replace with your actual API key
      const YARNGPT_API_URL = 'https://yarngpt.ai/api/v1/tts';
      
      // Voice mapping - English & Yoruba only
      const languageConfig = {
        'english': { 
          voice: 'Idera', 
          flag: 'üá¨üáß', 
          name: 'English',
          recognitionLang: 'en-NG'
        },
        'yoruba': { 
          voice: 'Wura', 
          flag: 'üá≥üá¨', 
          name: 'Yoruba',
          recognitionLang: 'yo-NG'
        }
      };

      // ==================== EMERGENCY KEYWORDS ====================
      const emergencyKeywords = {
        'english': ['help', 'emergency', 'fell', 'fall', 'pain', 'hurt', 'call', 'doctor', 'ambulance', 'save me', 'i need help'],
        'yoruba': ['egba mi', 'ran mi', 'irora', '·π£ubu', 'pajawiri', 'egba mi o', 'iranl·ªçw·ªç', 'd√≥k√≠t√†', 'owo', '·π£e iranl·ªçw·ªç']
      };

      // ==================== CONVERSATIONAL RESPONSES ====================
      const responses = {
        'english': {
          greetings: [
            "Hello! How are you feeling today?",
            "Good to hear from you! How can I help?",
            "I'm here for you. What do you need?"
          ],
          health: [
            "How are you feeling? Have you taken your medication?",
            "Remember to rest if you're tired. Can I help with anything?",
            "Your health is important. Do you need me to remind you about your medication?"
          ],
          emergency: [
            "I understand you need help. I'm calling your caregiver now.",
            "Don't worry, help is on the way. Connecting you to your caregiver.",
            "Emergency services have been alerted. Stay calm, help is coming."
          ],
          fallback: [
            "I'm here with you. How can I assist?",
            "Tell me more about that. I'm listening.",
            "I understand. What would you like me to help you with?"
          ]
        },
        'yoruba': {
          greetings: [
            "Bawo ni! ·π¢e √†l√†√°f√≠√† ni?",
            "Mo gb·ªçÃÅ ·ªç! Bawo ni mo ·π£e le ran ·ªç l·ªçÃÅw·ªçÃÅ?",
            "Mo w√† n√≠b√≠ f√∫n ·ªç. K√≠ l'o f·∫πÃÅ?"
          ],
          health: [
            "Bawo ni ara r·∫π ·π£e r√≠? ·π¢e o ti mu o√≤g√πn r·∫π?",
            "R√°nt√≠ l√°ti sinmi t√≠ o b√° r·∫πÃÄ. ·π¢√© mo l√® ·π£e n«πkan kan f√∫n ·ªç?",
            "√ålera r·∫π ·π£e p√†t√†k√¨. ·π¢√© o f·∫πÃÅ k√≠ n r√°n ·ªç l√©t√≠ n√≠pa o√≤g√πn r·∫π?"
          ],
          emergency: [
            "√ì y√© mi p√© o n√≠l√≤ √¨r√†nl·ªçÃÅw·ªçÃÅ. Mo n p√® ol√πt·ªçÃÅj√∫ r·∫π n√≠sis√¨y√≠.",
            "M√° ·π£e d√†√†m√∫, √¨r√†nl·ªçÃÅw·ªçÃÅ ≈Ñ b·ªçÃÄ. Mo n so ·ªç p·ªçÃÄ m·ªçÃÅ ol√πt·ªçÃÅj√∫ r·∫π.",
            "Mo ti fi √¨r√†nl·ªçÃÅw·ªçÃÅ p√†j√°w√¨r√≠ r√°n·π£·∫πÃÅ. J·ªçÃÄw·ªçÃÅ, farabal·∫πÃÄ, √¨r√†nl·ªçÃÅw·ªçÃÅ ≈Ñ b·ªçÃÄ."
          ],
          fallback: [
            "Mo w√† n√≠b√≠ p·∫πÃÄl√∫ r·∫π. Bawo ni mo ·π£e le r√†n ·ªçÃÅ l·ªçÃÅw·ªçÃÅ?",
            "S·ªç f√∫n mi d√≠·∫πÃÄ si n√≠pa iy·∫πn. Mo ≈Ñ gb·ªçÃÅ ·ªç.",
            "√ì y√© mi. K√≠ ni o f·∫πÃÅ k√≠ n r√†n ·ªçÃÅ l·ªçÃÅw·ªçÃÅ p·∫πÃÄl√∫?"
          ]
        }
      };

      // ==================== STATE ====================
      let currentLanguage = localStorage.getItem('preferredLanguage') || 'english';
      let isListening = false;
      let recognition = null;
      let audioContext = null;
      let callTimer = null;
      let callSeconds = 0;
      let ringtoneAudio = null;

      // ==================== INITIALIZATION ====================
      document.addEventListener('DOMContentLoaded', () => {
        setLanguage(currentLanguage);
        initAudio();
        createRingtone();
        
        // Add welcome message
        setTimeout(() => {
          const welcome = currentLanguage === 'english' 
            ? "Hello! I'm your ElderCare AI assistant. Tap the microphone and speak to me in English or Yoruba. I'll respond in the same language! If you need help, just say 'Help' or 'Egba mi o'."
            : "·∫∏ k√∫ √¨b·ªçn√∫! Emi ni iranl·ªçw√≥ AI r·∫π. T·∫π gbohungbohun ki o s·ªçÃÄr·ªçÃÄ n√≠ √®d√® G·∫πÃÄ·∫πÃÅs√¨ t√†b√≠ Yor√πb√°. Emi y√≥√≤ d√°h√πn n√≠ √®d√® kanna! T√≥ o b√° n√≠l√≤ √¨r√†nl·ªçÃÅw·ªçÃÅ, s·ªç 'Egba mi o' t√†b√≠ 'Help'.";
          
          addMessage('ai', welcome);
        }, 500);
      });

      // ==================== CREATE RINGTONE ====================
      function createRingtone() {
        try {
          ringtoneAudio = new Audio();
          // Using Web Audio API to generate a simple ringtone
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          
          oscillator.type = 'sine';
          oscillator.frequency.value = 800;
          gainNode.gain.value = 0;
          
          // Create ringtone pattern
          const now = audioCtx.currentTime;
          for (let i = 0; i < 10; i++) {
            gainNode.gain.setValueAtTime(0.5, now + i * 2);
            gainNode.gain.setValueAtTime(0, now + i * 2 + 1);
          }
          
          oscillator.start();
          
          // MediaStream destination for ringtone
          const destination = audioCtx.createMediaStreamDestination();
          oscillator.connect(destination);
          
          // Create audio element from stream
          ringtoneAudio = new Audio();
          ringtoneAudio.srcObject = destination.stream;
          ringtoneAudio.loop = true;
        } catch (e) {
          console.log('Ringtone creation failed, using fallback');
          // Fallback - create a simple beep pattern using setInterval
        }
      }

      // ==================== EMERGENCY CALL FUNCTION ====================
      function triggerEmergencyCall(language) {
        // Show emergency modal
        document.getElementById('emergencyCallModal').classList.remove('hidden');
        
        // Update text based on language
        if (language === 'english') {
          document.getElementById('emergencyTitle').innerText = 'EMERGENCY CALL';
          document.getElementById('emergencyContact').innerText = 'Contacting Caregiver...';
          document.getElementById('emergencyMessage').innerText = 'Help is on the way';
          document.getElementById('endCallText').innerText = 'End Call';
          document.getElementById('emergencyNote').innerText = 'Emergency services have been notified';
        } else {
          document.getElementById('emergencyTitle').innerText = 'IÃÄPEÃÄ PAÃÄJAÃÄWIÃÅRIÃÄ';
          document.getElementById('emergencyContact').innerText = 'OluÃÄtoÃÅjuÃÅ n boÃÄ...';
          document.getElementById('emergencyMessage').innerText = 'IÃÄraÃÄnl·ªçÃÅw·ªçÃÅ n boÃÄ';
          document.getElementById('endCallText').innerText = 'Pa iÃÄpeÃÄ';
          document.getElementById('emergencyNote').innerText = 'A ti fi toÃÅ aÃÄw·ªçn oloÃÅoÃÄ·π£eÃÄfuÃÄnfuÃÄn letiÃÅ';
        }
        
        // Start call timer
        callSeconds = 0;
        updateCallTimer();
        callTimer = setInterval(updateCallTimer, 1000);
        
        // Play ringtone
        playRingtone();
        
        // Add emergency message to conversation
        const emergencyMsg = language === 'english' 
          ? "üö® EMERGENCY: Calling caregiver now..."
          : "üö® PAÃÄJAÃÄWIÃÅRIÃÄ: OÃÄ n pe oluÃÄtoÃÅjuÃÅ niÃÅsis√¨yiÃÅ...";
        addMessage('ai', emergencyMsg);
        
        // Simulate call connection after 5 seconds
        setTimeout(() => {
          if (document.getElementById('emergencyCallModal').classList.contains('hidden')) return;
          
          if (language === 'english') {
            document.getElementById('emergencyContact').innerText = 'Connected to Caregiver';
            document.getElementById('emergencyMessage').innerText = 'They are on the line';
          } else {
            document.getElementById('emergencyContact').innerText = 'O ti so po mo OluÃÄtoÃÅjuÃÅ';
            document.getElementById('emergencyMessage').innerText = 'O n ba o soro ni bayi';
          }
          
          stopRingtone();
        }, 5000);
      }

      function updateCallTimer() {
        callSeconds++;
        const minutes = Math.floor(callSeconds / 60);
        const seconds = callSeconds % 60;
        document.getElementById('callTimer').innerText = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      function playRingtone() {
        if (ringtoneAudio) {
          ringtoneAudio.loop = true;
          ringtoneAudio.play().catch(e => console.log('Ringtone play failed:', e));
        }
      }

      function stopRingtone() {
        if (ringtoneAudio) {
          ringtoneAudio.pause();
          ringtoneAudio.currentTime = 0;
        }
      }

      function endEmergencyCall() {
        stopRingtone();
        clearInterval(callTimer);
        document.getElementById('emergencyCallModal').classList.add('hidden');
        
        // Add end call message
        const endMsg = currentLanguage === 'english' 
          ? "Call ended. Stay safe! Emergency services have been notified."
          : "IÃÄpeÃÄ pari. Di aÃÄlaÃÄaÃÅfiÃÅaÃÄ duÃÅroÃÅ! A ti fi toÃÅ aÃÄw·ªçn oloÃÅoÃÄ·π£eÃÄfuÃÄnfuÃÄn letiÃÅ.";
        addMessage('ai', endMsg);
      }

      // ==================== CHECK FOR EMERGENCY ====================
      function checkForEmergency(message, language) {
        const lower = message.toLowerCase();
        const keywords = emergencyKeywords[language] || emergencyKeywords.english;
        
        return keywords.some(keyword => lower.includes(keyword));
      }

      function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('preferredLanguage', lang);
        
        // Update UI language
        const config = languageConfig[lang];
        document.getElementById('activeLanguage').innerHTML = `${config.flag} ${config.name}`;
        
        // Update button styles
        document.getElementById('lang-en').classList.remove('bg-primary', 'text-white');
        document.getElementById('lang-yo').classList.remove('bg-primary', 'text-white');
        
        if (lang === 'english') {
          document.getElementById('lang-en').classList.add('bg-primary', 'text-white');
          document.getElementById('lang-yo').classList.add('text-slate-600', 'dark:text-slate-400');
        } else {
          document.getElementById('lang-yo').classList.add('bg-primary', 'text-white');
          document.getElementById('lang-en').classList.add('text-slate-600', 'dark:text-slate-400');
        }
        
        // Update text content based on language
        updateUIText(lang);
        
        // Update status text
        document.getElementById('statusText').innerHTML = lang === 'english' 
          ? 'Tap the microphone to start' 
          : 'T·∫π gbohungbohun l√°ti b·∫πÃÄr·∫πÃÄ';
      }

      function updateUIText(lang) {
        if (lang === 'english') {
          document.getElementById('conversationHeader').innerHTML = 'Conversation';
          document.getElementById('remindersText').innerHTML = 'Reminders';
          document.getElementById('homeText').innerHTML = 'Home';
          document.getElementById('remindersNavText').innerHTML = 'Reminders';
          document.getElementById('dashboardText').innerHTML = 'Dashboard';
        } else {
          document.getElementById('conversationHeader').innerHTML = '√åb√°nis·ªçÃÄr·ªçÃÄ';
          document.getElementById('remindersText').innerHTML = '√å·π£·∫πÃÅl·∫πÃÅt√¨';
          document.getElementById('homeText').innerHTML = 'Il√©';
          document.getElementById('remindersNavText').innerHTML = '√år√°nt√≠';
          document.getElementById('dashboardText').innerHTML = '√Äk√≥j·ªçp·ªçÃÄ';
        }
      }

      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
      }

      // ==================== YARNGPT TEXT-TO-SPEECH ====================
      async function speakWithYarnGPT(text, language) {
        const config = languageConfig[language] || languageConfig.english;
        
        try {
          document.getElementById('statusText').innerHTML = language === 'english' ? 'Speaking...' : '≈É s·ªçÃÄr·ªçÃÄ...';
          
          const response = await fetch(YARNGPT_API_URL, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${YARNGPT_API_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              text: text,
              voice: config.voice,
              response_format: 'mp3'
            })
          });

          if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            await audio.play();
            
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
              document.getElementById('statusText').innerHTML = currentLanguage === 'english' 
                ? 'Tap the microphone to start' 
                : 'T·∫π gbohungbohun l√°ti b·∫πÃÄr·∫πÃÄ';
            };
            
            return true;
          } else {
            console.error('YarnGPT error, using fallback');
            return fallbackSpeak(text, language);
          }
        } catch (error) {
          console.error('YarnGPT failed:', error);
          return fallbackSpeak(text, language);
        }
      }

      // ==================== FALLBACK TTS ====================
      function fallbackSpeak(text, language) {
        if (!('speechSynthesis' in window)) return false;

        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        const langCodes = {
          'english': 'en-NG',
          'yoruba': 'yo-NG'
        };
        
        utterance.lang = langCodes[language] || 'en-NG';
        utterance.rate = 0.9;
        
        utterance.onend = () => {
          document.getElementById('statusText').innerHTML = currentLanguage === 'english' 
            ? 'Tap the microphone to start' 
            : 'T·∫π gbohungbohun l√°ti b·∫πÃÄr·∫πÃÄ';
        };
        
        window.speechSynthesis.speak(utterance);
        return true;
      }

      // ==================== DETECT LANGUAGE FROM TEXT ====================
      function detectLanguageFromText(text) {
        const lower = text.toLowerCase();
        
        // Yoruba detection
        if (/(bawo|·π£e|·ªç|daadaa|oogun|ile|nib·∫π|k√≠|≈Ñ ·π£e|·∫π n l·∫π|mo wa|k√≠ ni|r·∫π|f·∫πÃÅ|s·ªçÃÄr·ªçÃÄ|in√∫ mi|ara r·∫π|b√°wo ni|egba|ran mi|irora|·π£ubu|pajawiri)/.test(lower)) {
          return 'yoruba';
        }
        
        return 'english';
      }

      // ==================== GENERATE RESPONSE ====================
      function generateResponse(message, language) {
        const lower = message.toLowerCase();
        const langResponses = responses[language];
        
        // Emergency check
        if (checkForEmergency(message, language)) {
          return langResponses.emergency[Math.floor(Math.random() * langResponses.emergency.length)];
        }
        
        // Greeting check
        const greetings = language === 'english' 
          ? ['hello', 'hi', 'hey', 'good', 'how']
          : ['bawo', 'k√≠ l√≥', '·π£e daadaa', 'n l·∫π', '·∫π n l·∫π'];
          
        if (greetings.some(g => lower.includes(g))) {
          return langResponses.greetings[Math.floor(Math.random() * langResponses.greetings.length)];
        }
        
        // Health check
        const healthWords = language === 'english'
          ? ['pain', 'sick', 'hurt', 'medication', 'medicine', 'feel', 'health']
          : ['irora', 'aisan', 'oogun', '√¨lera', '√†√¨s√†n', 'ara r·∫π'];
          
        if (healthWords.some(w => lower.includes(w))) {
          return langResponses.health[Math.floor(Math.random() * langResponses.health.length)];
        }
        
        return langResponses.fallback[Math.floor(Math.random() * langResponses.fallback.length)];
      }

      // ==================== VOICE RECOGNITION ====================
      function startListening() {
        if (isListening) return;
        
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Voice input not supported. Please use Chrome or Edge.');
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = 'en-NG';
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.maxAlternatives = 3;

        // Update UI
        isListening = true;
        document.getElementById('statusText').innerHTML = currentLanguage === 'english' ? 'üé§ Listening...' : 'üé§ ≈É gb·ªçÃÅr·ªçÃÄ...';
        document.getElementById('micIcon').textContent = 'mic_off';
        document.getElementById('micPulse').classList.add('listening-pulse');

        recognition.start();

        recognition.onresult = async (event) => {
          const userMessage = event.results[0][0].transcript;
          console.log('User said:', userMessage);
          
          // Detect language
          const detectedLang = detectLanguageFromText(userMessage);
          if (detectedLang !== currentLanguage) {
            setLanguage(detectedLang);
          }
          
          // Add user message to conversation
          addMessage('user', userMessage);
          
          // Check for emergency FIRST - before anything else
          if (checkForEmergency(userMessage, currentLanguage)) {
            triggerEmergencyCall(currentLanguage);
          }
          
          // Show thinking state
          document.getElementById('statusText').innerHTML = currentLanguage === 'english' 
            ? '<span class="thinking-dots">Thinking</span>' 
            : '<span class="thinking-dots">≈É ron√∫</span>';
          
          // Generate and speak response
          setTimeout(async () => {
            const aiResponse = generateResponse(userMessage, currentLanguage);
            addMessage('ai', aiResponse);
            await speakWithYarnGPT(aiResponse, currentLanguage);
          }, 800);
        };

        recognition.onerror = (event) => {
          console.error('Recognition error:', event.error);
          resetListening();
        };

        recognition.onend = () => {
          resetListening();
        };
      }

      function resetListening() {
        isListening = false;
        document.getElementById('micIcon').textContent = 'mic';
        document.getElementById('micPulse').classList.remove('listening-pulse');
        
        if (!document.getElementById('statusText').innerHTML.includes('Tap') && 
            !document.getElementById('statusText').innerHTML.includes('T·∫π')) {
          document.getElementById('statusText').innerHTML = currentLanguage === 'english' 
            ? 'Tap the microphone to start' 
            : 'T·∫π gbohungbohun l√°ti b·∫πÃÄr·∫πÃÄ';
        }
      }

      // ==================== CONVERSATION DISPLAY ====================
      function addMessage(sender, message) {
        const container = document.getElementById('conversationHistory');
        const messageDiv = document.createElement('div');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        if (sender === 'user') {
          messageDiv.className = 'flex items-start gap-3 justify-end';
          messageDiv.innerHTML = `
            <div class="bg-primary/10 rounded-2xl rounded-tr-none p-4 max-w-[80%] shadow-sm">
              <p class="text-sm text-slate-700 dark:text-slate-300">${message}</p>
              <span class="text-xs text-slate-400 mt-2 block">${time}</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
              <span class="material-symbols-outlined text-primary text-sm">person</span>
            </div>
          `;
        } else {
          const config = languageConfig[currentLanguage];
          messageDiv.className = 'flex items-start gap-3';
          messageDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
              <span class="material-symbols-outlined text-primary text-sm">smart_toy</span>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-medium text-primary">${config.flag} ${config.name}</span>
                <span class="text-xs text-slate-400">${config.voice}</span>
              </div>
              <p class="text-sm text-slate-700 dark:text-slate-300">${message}</p>
              <span class="text-xs text-slate-400 mt-2 block">${time}</span>
            </div>
          `;
        }
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      // ==================== MODAL FUNCTIONS ====================
      function showModal() {
        document.getElementById('exitModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      
      function closeModal() {
        document.getElementById('exitModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
      
      window.onclick = function(event) {
        const modal = document.getElementById('exitModal');
        if (event.target === modal) closeModal();
      }
    </script>
  </body>
</html>